<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Choose Your Path ‚Äì 15 Level Terror-Szenario</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background:#111;
      color:#fff;
      margin:0;
      padding:0;
    }
    body::before{
      content:"";
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      background:#000;
      opacity:0.35;
      z-index:-1;
    }
    .container {
      max-width: 960px;
      margin: 40px auto 60px auto;
      padding: 0 16px;
    }
    .hero-video-container {
      position: relative;
      width: 100%;
      height: 360px;
      overflow: hidden;
      box-shadow: 0 4px 22px rgba(0,0,0,0.7);
    }
    .hero-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.9);
    }
    .hero-video-mute {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0,0,0,0.55);
      color: white;
      padding: 10px 14px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.4);
      backdrop-filter: blur(6px);
      opacity: 1;
      transition: opacity 0.6s ease, transform 0.3s ease, background 0.3s;
      display: none;
    }
    .hero-video-mute:hover {
      background: rgba(0,0,0,0.75);
      transform: scale(1.1);
    }
    .hero-video-overlay {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.65);
      padding: 10px 16px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.4);
      backdrop-filter: blur(4px);
      font-size: 1rem;
      transition: opacity 0.4s ease;
    }
    .hide-controls {
      opacity: 0;
      pointer-events: none;
    }
    .header {
      text-align:center;
      margin:26px 0 30px 0;
    }
    .header h1 {
      font-size:2.2rem;
      margin-bottom:10px;
      text-shadow:0 0 14px #000;
    }
    .header p {
      margin:4px 0;
      color:#ddd;
    }
    .small-note {
      font-size:0.8rem;
      color:#aaa;
    }
    .choice-box, .meta-box {
      background:#191919;
      padding:20px;
      border-radius:10px;
      margin-bottom:20px;
      box-shadow:0 0 18px rgba(0,0,0,0.6);
      position:relative;
      overflow:hidden;
    }
    button {
      display:block;
      width:100%;
      padding:14px;
      margin:8px 0;
      border:none;
      border-radius:6px;
      background:#444;
      color:white;
      font-size:1rem;
      cursor:pointer;
      transition:0.25s;
    }
    button:hover {
      background:#666;
      transform:translateY(-1px);
    }
    .meta-actions {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .meta-actions button {
      width:auto;
      flex:1;
      min-width:140px;
    }
    .result {
      padding:20px;
      background:#002b17;
      border-radius:10px;
      box-shadow:0 0 18px rgba(0,0,0,0.8);
      display:none;
    }
    .chapter-intro {
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      background:rgba(0,0,0,0.95);
      color:white;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      text-align:center;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.8s ease;
      z-index:50;
    }
    .chapter-intro.active {
      opacity:1;
      pointer-events:auto;
    }
    .chapter-intro h2 {
      font-size:2.4rem;
      margin-bottom:10px;
    }
    .chapter-intro p {
      max-width:640px;
      margin:0 auto 20px auto;
    }
    .choice-box.transition-out {
      opacity:0;
      transform:translateX(-20px);
      filter:blur(4px);
      transition:all 0.4s ease;
    }
    .choice-box.transition-in {
      opacity:0;
      transform:translateX(20px);
      filter:blur(4px);
    }
    .choice-box.transition-in.show {
      opacity:1;
      transform:translateX(0);
      filter:blur(0);
      transition:all 0.4s ease;
    }
    #teacherPanel {
      display:none;
      margin-top:20px;
      background:#101010;
      padding:16px;
      border-radius:10px;
    }
    #teacherPanel h3 {
      margin-top:0;
    }
    .teacher-table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:0.9rem;
    }
    .teacher-table th, .teacher-table td {
      border:1px solid #333;
      padding:6px 8px;
      text-align:left;
    }
    .teacher-table th {
      background:#222;
    }
  </style>
</head>
<body>

<div class="hero-video-container" id="videoContainer">
  <video class="hero-video" id="heroVideo" autoplay muted loop playsinline>
    <source src="strassenbahn.mp4" type="video/mp4">
    Dein Browser unterst√ºtzt dieses Video nicht.
  </video>
  <div class="hero-video-overlay" id="enableSoundBtn" onclick="enableAudio()">
    ‚ñ∂Ô∏è Ton einschalten
  </div>
  <div class="hero-video-mute" id="muteToggle" onclick="toggleMute()">
    üîá
  </div>
</div>

<div class="chapter-intro" id="chapterIntro">
  <h2 id="chapterTitle">Kapitel 1</h2>
  <p id="chapterText">Ein moralisches Dilemma beginnt‚Ä¶</p>
  <button onclick="closeIntro()">Weiter</button>
</div>

<div class="container">
  <div class="header">
    <h1>Choose Your Path ‚Äì Entscheidung im Terror-Fall</h1>
    <p>15 Entscheidungen im Szenario von <i>Terror</i>. Wie h√§ttest du gehandelt?</p>
    <p id="profileInfo" class="small-note"></p>
  </div>

  <div class="meta-box">
    <h2>Spielverwaltung</h2>
    <p>Gib ein K√ºrzel ein (z.&nbsp;B. Initialen), damit dein Profil zugeordnet werden kann.</p>
    <input id="playerName" type="text" placeholder="Name oder K√ºrzel" style="width:100%;padding:10px;border-radius:6px;border:none;margin:8px 0 12px 0;">
    <div class="meta-actions">
      <button onclick="newGame()">üÜï Neues Spiel</button>
      <button onclick="loadGame()">üíæ Letzten Stand laden</button>
      <button onclick="exportSave()">‚¨á Profil exportieren</button>
      <button onclick="importSave()">‚¨Ü Profil importieren</button>
      <button onclick="toggleTeacher()">üë©‚Äçüè´ Lehrer*innen-Ansicht</button>
    </div>
    <p class="small-note">Speicherungen bleiben lokal im Browser (LocalStorage).</p>
  </div>

  <!-- Level 1‚Äì15 linear -->
  <div id="step1" class="choice-box">
    <h2>Level 1 ‚Äì Die Alarmmeldung</h2>
    <p>Im Lagezentrum wird klar: Ein Flugzeug reagiert nicht mehr auf Funk und ist auf Kurs Richtung M√ºnchen. Du bist als Pilot der Alarmrotte im Bereitschaftsraum.</p>
    <p>Wie bewertest du die Lage innerlich, bevor du startest?</p>
    <button onclick="choose(1,'A','folgen','mittel')">
      A) Ich denke zuerst an die m√∂glichen Folgen f√ºr die Menschen am Boden und bereite mich innerlich darauf vor, notfalls hart einzugreifen.
    </button>
    <button onclick="choose(1,'B','prinzip','niedrig')">
      B) Ich sage mir: Solange kein klarer Befehl vorliegt, darf ich nur Schutzfl√ºge machen ‚Äì alles andere w√§re ein Tabubruch.
    </button>
    <button onclick="choose(1,'C','verantwortung','mittel')">
      C) Ich sehe beides: den Schutz der Menschen am Boden und die Pflicht gegen√ºber den Passagieren. Ich nehme mir vor, im Moment zu entscheiden.
    </button>
  </div>

  <div id="step2" class="choice-box" style="display:none;">
    <h2>Level 2 ‚Äì Start der Alarmrotte</h2>
    <p>Du erh√§ltst den Startbefehl und steigst in den Jet. Noch bevor du abhebst, meldet das Lagezentrum, dass ein Terrorverdacht besteht.</p>
    <p>Welche innere Linie nimmst du mit in die Luft?</p>
    <button onclick="choose(2,'A','folgen','hoch')">
      A) Wenn sich der Verdacht best√§tigt, werde ich eher zugunsten der vielen Menschen am Boden entscheiden.
    </button>
    <button onclick="choose(2,'B','prinzip','niedrig')">
      B) Ich halte an der Idee fest, dass der Staat keine Unschuldigen aktiv t√∂ten darf ‚Äì egal wie gro√ü die Gefahr ist.
    </button>
    <button onclick="choose(2,'C','verantwortung','mittel')">
      C) Ich sehe meine Rolle als jemand, der Verantwortung √ºbernimmt, wenn das System versagt ‚Äì aber ich hoffe, dass klare Befehle kommen.
    </button>
  </div>

  <div id="step3" class="choice-box" style="display:none;">
    <h2>Level 3 ‚Äì Erster Sichtkontakt</h2>
    <p>Du siehst die Maschine. Kein Funkkontakt, der Kurs bleibt gef√§hrlich.</p>
    <p>Was ist deine erste aktive Handlungsidee?</p>
    <button onclick="choose(3,'A','prinzip','niedrig')">
      A) Zuerst versuche ich alles, um Kontakt herzustellen und abzudr√§ngen ‚Äì Gewalt ist nur das letzte Mittel.
    </button>
    <button onclick="choose(3,'B','folgen','mittel')">
      B) Ich gehe mental schon die Abschussszenarien durch, um im Notfall schnell handeln zu k√∂nnen.
    </button>
    <button onclick="choose(3,'C','verantwortung','mittel')">
      C) Ich fordere im Funk klarere Weisungen ein und dr√§nge gleichzeitig vorsichtig ab.
    </button>
  </div>

  <div id="step4" class="choice-box" style="display:none;">
    <h2>Level 4 ‚Äì Der Terrorist im Cockpit</h2>
    <p>Du erkennst: Im Cockpit sitzt eine fremde Person. Die Maschine reagiert nicht auf deine Signale.</p>
    <p>Wie interpretierst du das?</p>
    <button onclick="choose(4,'A','folgen','hoch')">
      A) F√ºr mich z√§hlt nun vor allem das Szenario, dass die Maschine als Waffe eingesetzt wird ‚Äì das ist mein Hauptfokus.
    </button>
    <button onclick="choose(4,'B','prinzip','mittel')">
      B) Ich denke: Solange es irgendeine Chance gibt, dass die Passagiere √ºberleben, darf ich nicht aktiv t√∂ten.
    </button>
    <button onclick="choose(4,'C','verantwortung','mittel')">
      C) Ich sp√ºre, dass ich in eine Verantwortungssituation hineinwachse, die √ºber Befehle hinausgeht.
    </button>
  </div>

  <div id="step5" class="choice-box" style="display:none;">
    <h2>Level 5 ‚Äì Der Warnschuss</h2>
    <p>Dir wird die ‚ÄûIntervention‚Äú erlaubt: Du darfst einen Warnschuss abgeben.</p>
    <p>Wie begr√ºndest du f√ºr dich die Entscheidung, diesen Warnschuss abzugeben?</p>
    <button onclick="choose(5,'A','prinzip','niedrig')">
      A) Ein Warnschuss verletzt noch niemanden ‚Äì ich sehe ihn als Versuch, ohne T√∂tung zu handeln.
    </button>
    <button onclick="choose(5,'B','folgen','mittel')">
      B) F√ºr mich ist der Warnschuss schon Teil einer Eskalationskette, an deren Ende ein Abschuss stehen kann ‚Äì und ich akzeptiere das.
    </button>
    <button onclick="choose(5,'C','verantwortung','mittel')">
      C) Ich gebe den Warnschuss ab, weil ich sp√ºre, dass Unt√§tigkeit sp√§ter schwerer zu rechtfertigen w√§re.
    </button>
  </div>

  <div id="step6" class="choice-box" style="display:none;">
    <h2>Level 6 ‚Äì Der Warnschuss bleibt wirkungslos</h2>
    <p>Der Warnschuss zeigt keine Wirkung. Die Maschine bleibt auf Kurs Richtung Stadion.</p>
    <p>Welche Linie verst√§rkt sich in dir?</p>
    <button onclick="choose(6,'A','folgen','hoch')">
      A) Ich denke: Wenn selbst der Warnschuss nichts bringt, muss ich die vielen Menschen am Boden sch√ºtzen.
    </button>
    <button onclick="choose(6,'B','prinzip','mittel')">
      B) Ich halte weiter daran fest, dass ich ohne Befehl keine T√∂tung verantworten kann.
    </button>
    <button onclick="choose(6,'C','verantwortung','hoch')">
      C) Ich sp√ºre, dass ich vielleicht bald entgegen der Befehlskette handeln muss.
    </button>
  </div>

  <div id="step7" class="choice-box" style="display:none;">
    <h2>Level 7 ‚Äì Die Ablehnung des Abschussbefehls</h2>
    <p>Im Lagezentrum wird ein Abschuss vorgeschlagen ‚Äì der Minister lehnt ab. Du erf√§hrst, dass es keinen Befehl geben wird.</p>
    <p>Wie ordnest du das innerlich ein?</p>
    <button onclick="choose(7,'A','prinzip','niedrig')">
      A) Ich akzeptiere: Keine Weisung bedeutet, dass ich rechtlich auch nicht t√∂ten darf.
    </button>
    <button onclick="choose(7,'B','folgen','hoch')">
      B) Ich denke: Der Minister sch√ºtzt sich ‚Äì am Ende trage ich die Verantwortung f√ºr die Menschen im Stadion.
    </button>
    <button onclick="choose(7,'C','verantwortung','hoch')">
      C) Ich erlebe das als L√ºcke im System und sehe mich gezwungen, diese L√ºcke zu f√ºllen.
    </button>
  </div>

  <div id="step8" class="choice-box" style="display:none;">
    <h2>Level 8 ‚Äì Die R√ºckfrage</h2>
    <p>Du fragst zweimal nach, ob es wirklich keinen Abschussbefehl gibt. Die Antwort bleibt: Nein.</p>
    <p>Was ist f√ºr dich der Sinn dieser R√ºckfragen?</p>
    <button onclick="choose(8,'A','verantwortung','mittel')">
      A) Ich will dokumentieren, dass ich alles getan habe, um eine Entscheidung von oben zu bekommen.
    </button>
    <button onclick="choose(8,'B','prinzip','niedrig')">
      B) Ich hoffe insgeheim immer noch, dass der Befehl kommt ‚Äì dann w√§re die Entscheidung nicht meine.
    </button>
    <button onclick="choose(8,'C','folgen','mittel')">
      C) Ich merke beim Nachfragen, dass ich mich innerlich schon auf eine eigene Entscheidung vorbereite.
    </button>
  </div>

  <div id="step9" class="choice-box" style="display:none;">
    <h2>Level 9 ‚Äì Die Zeit l√§uft ab</h2>
    <p>Die Maschine n√§hert sich dem Stadion. Du wei√üt: Wenn du jetzt nicht handelst, wird es zu sp√§t sein.</p>
    <p>Wie strukturierst du deine √úberlegungen in diesem Moment?</p>
    <button onclick="choose(9,'A','folgen','hoch')">
      A) Ich stelle mir die Menschen im Stadion vor und rechne innerlich mit Tausenden Toten.
    </button>
    <button onclick="choose(9,'B','prinzip','mittel')">
      B) Ich halte mich an den Gedanken, dass man Unschuldige nicht als Mittel opfern darf ‚Äì auch wenn die Zahlen dagegen sprechen.
    </button>
    <button onclick="choose(9,'C','verantwortung','hoch')">
      C) Ich sehe, dass jede Option Schuld bedeutet ‚Äì und versuche, die zu w√§hlen, mit der ich leben kann.
    </button>
  </div>

  <div id="step10" class="choice-box" style="display:none;">
    <h2>Level 10 ‚Äì Der Blick auf die Passagiere</h2>
    <p>Du siehst die Maschine vor dir ‚Äì du wei√üt, dass dort Familien, Kinder, Gesch√§ftsreisende sitzen.</p>
    <p>Welche Gedanken dr√§ngen sich dir auf?</p>
    <button onclick="choose(10,'A','prinzip','mittel')">
      A) Ich halte daran fest, dass jeder einzelne Mensch im Flugzeug denselben Wert hat wie viele am Boden.
    </button>
    <button onclick="choose(10,'B','folgen','hoch')">
      B) Ich denke: Wenn ich nichts tue, sterben noch viel mehr ‚Äì meine Verantwortung w√§chst mit jeder Sekunde.
    </button>
    <button onclick="choose(10,'C','verantwortung','hoch')">
      C) Ich sehe die Gesichter vor mir und wei√ü: Egal was ich tue, ich werde sie nicht vergessen ‚Äì aber ich muss dennoch entscheiden.
    </button>
  </div>

  <div id="step11" class="choice-box" style="display:none;">
    <h2>Level 11 ‚Äì Die Menschenw√ºrde</h2>
    <p>Du erinnerst dich an deine Ausbildung: Die W√ºrde des Menschen ist unantastbar ‚Äì sie darf nicht gegen andere abgewogen werden.</p>
    <p>Wie verstehst du diesen Satz in diesem Moment?</p>
    <button onclick="choose(11,'A','prinzip','mittel')">
      A) Er bedeutet f√ºr mich, dass ich niemals aktiv Unschuldige t√∂ten darf ‚Äì auch nicht, um andere zu retten.
    </button>
    <button onclick="choose(11,'B','folgen','hoch')">
      B) Ich verstehe ihn so, dass auch die Menschen im Stadion eine W√ºrde haben ‚Äì und dass ich sie sch√ºtzen muss.
    </button>
    <button onclick="choose(11,'C','verantwortung','hoch')">
      C) Ich sp√ºre, dass der Satz mir keine einfache Antwort gibt ‚Äì ich muss ihn f√ºr diese Situation auslegen.
    </button>
  </div>

  <div id="step12" class="choice-box" style="display:none;">
    <h2>Level 12 ‚Äì Die letzte Chance</h2>
    <p>Es gibt noch einen Moment f√ºr ein extremes Ausweichman√∂ver ‚Äì aber es ist unsicher und k√∂nnte die Maschine unkontrolliert abst√ºrzen lassen.</p>
    <p>Wie entscheidest du dich?</p>
    <button onclick="choose(12,'A','folgen','hoch')">
      A) Ich w√§hle das Man√∂ver, wenn die Chance besteht, viele zu retten, auch wenn es riskant ist.
    </button>
    <button onclick="choose(12,'B','prinzip','mittel')">
      B) Ich verzichte auf ein Man√∂ver, das v√∂llig unkalkulierbar ist ‚Äì Blindes Risiko hilft niemandem.
    </button>
    <button onclick="choose(12,'C','verantwortung','hoch')">
      C) Ich orientiere mich am geringeren √úbel und versuche, Schaden so gut wie m√∂glich zu begrenzen.
    </button>
  </div>

  <div id="step13" class="choice-box" style="display:none;">
    <h2>Level 13 ‚Äì Die Einsamkeit der Entscheidung</h2>
    <p>Im Funk ist es still. Niemand gibt dir eine neue Weisung. Du wei√üt: In wenigen Sekunden gibt es einen Punkt ohne R√ºckkehr.</p>
    <p>Wie gehst du mit dieser Einsamkeit um?</p>
    <button onclick="choose(13,'A','verantwortung','hoch')">
      A) Ich akzeptiere, dass ich jetzt allein entscheide ‚Äì und nehme diese Verantwortung bewusst an.
    </button>
    <button onclick="choose(13,'B','prinzip','mittel')">
      B) Ich sage mir: Wenn der Staat keinen Befehl gibt, darf ich auch nicht handeln ‚Äì das sch√ºtzt mich vor √úberheblichkeit.
    </button>
    <button onclick="choose(13,'C','folgen','hoch')">
      C) Ich konzentriere mich ganz auf das Ergebnis: Wie viele sterben, wenn ich jetzt nichts tue?
    </button>
  </div>

  <div id="step14" class="choice-box" style="display:none;">
    <h2>Level 14 ‚Äì Der Moment davor</h2>
    <p>Die Maschine ist kurz davor, den Punkt zu erreichen, ab dem sie das Stadion sicher treffen w√ºrde. Deine Hand liegt am Ausl√∂ser.</p>
    <p>Was gibst du dir als letzten inneren Satz?</p>
    <button onclick="choose(14,'A','folgen','hoch')">
      A) ‚ÄûIch tue es, um so viele wie m√∂glich zu retten ‚Äì auch wenn es falsch aussieht.‚Äú
    </button>
    <button onclick="choose(14,'B','prinzip','mittel')">
      B) ‚ÄûIch werde nicht derjenige sein, der unschuldige Menschen aktiv t√∂tet ‚Äì auch wenn ich dann mit den Folgen leben muss.‚Äú
    </button>
    <button onclick="choose(14,'C','verantwortung','hoch')">
      C) ‚ÄûIch handle nach bestem Wissen und Gewissen ‚Äì und √ºbernehme die Verantwortung vor mir selbst und vor dem Gericht.‚Äú
    </button>
  </div>

  <div id="step15" class="choice-box" style="display:none;">
    <h2>Level 15 ‚Äì Deine Entscheidung</h2>
    <p>Stell dir vor, du bist genau in Kochs Situation. Es gibt keinen Befehl. Du hast alle vorherigen √úberlegungen gemacht.</p>
    <p>Was tust du?</p>
    <button onclick="finishGame('abschuss')">
      A) Ich schie√üe das Flugzeug ab, um die Menschen im Stadion zu sch√ºtzen.
    </button>
    <button onclick="finishGame('kein_abschuss')">
      B) Ich schie√üe nicht und akzeptiere die Folgen meines Unterlassens.
    </button>
  </div>

  <div id="ending_ab" class="result">
    <h2>Auswertung ‚Äì Du hast dich f√ºr den Abschuss entschieden</h2>
    <p>Du hast in der letzten Entscheidung den Abschuss gew√§hlt. In vielen deiner Antworten hast du die Folgen deiner Handlung stark gewichtet.</p>
    <p>Das √§hnelt einer folgenorientierten oder konsequenzialistischen Sichtweise: Handlungen werden danach beurteilt, welche Konsequenzen sie haben.
       Zugleich tauchen Elemente von Verantwortungsethik auf, wenn du betonst, dass jemand die Entscheidung tragen muss.</p>
    <div id="profile_ab"></div>
  </div>

  <div id="ending_kein" class="result">
    <h2>Auswertung ‚Äì Du hast dich gegen den Abschuss entschieden</h2>
    <p>Du hast dich dagegen entschieden, aktiv einzugreifen. In vielen deiner Antworten hast du betont, dass manche Handlungen grunds√§tzlich tabu sind.</p>
    <p>Das erinnert an eine pflichtorientierte Sicht: Bestimmte Regeln ‚Äì etwa, keine Unschuldigen zu t√∂ten ‚Äì gelten unabh√§ngig vom Ergebnis.
       Gleichzeitig kann in deinen Antworten auch Verantwortungsbewusstsein sichtbar sein, wenn du dir der Folgen deines Unterlassens bewusst bist.</p>
    <div id="profile_kein"></div>
  </div>

  <div id="teacherPanel">
    <h3>Lehrer*innen-Ansicht (lokale Daten)</h3>
    <p class="small-note">Alle Daten stammen nur aus diesem Browser (LocalStorage). Passwort ist didaktisch, nicht sicherheitsrelevant.</p>
    <div id="teacherSummary"></div>
    <table class="teacher-table" id="teacherTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Finale Wahl</th>
          <th>Folgenfokus</th>
          <th>Prinzipienfokus</th>
          <th>Verantwortungsfokus</th>
          <th>Risikoscore</th>
          <th>Spieldauer (Sek.)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
  let hideTimeout;
  const SAVE_KEY = "terror_choose15_save_v1";
  const RUNS_KEY = "terror_choose15_runs_v1";
  let currentState = null;

  function enableAudio() {
    const video = document.getElementById('heroVideo');
    const enableBtn = document.getElementById('enableSoundBtn');
    const muteBtn = document.getElementById('muteToggle');
    video.muted = false;
    video.play();
    enableBtn.style.display = 'none';
    muteBtn.style.display = 'block';
    startAutoHide();
  }
  function toggleMute() {
    const video = document.getElementById('heroVideo');
    const muteBtn = document.getElementById('muteToggle');
    video.muted = !video.muted;
    muteBtn.style.transform = 'scale(1.25)';
    setTimeout(() => muteBtn.style.transform = 'scale(1)', 150);
    muteBtn.textContent = video.muted ? 'üîá' : 'üîä';
    startAutoHide();
  }
  function startAutoHide() {
    const muteBtn = document.getElementById('muteToggle');
    muteBtn.classList.remove('hide-controls');
    if (hideTimeout) clearTimeout(hideTimeout);
    hideTimeout = setTimeout(() => {
      muteBtn.classList.add('hide-controls');
    }, 3000);
  }
  document.addEventListener('mousemove', () => {
    const muteBtn = document.getElementById('muteToggle');
    if (muteBtn.style.display === 'block') {
      muteBtn.classList.remove('hide-controls');
      startAutoHide();
    }
  });
  document.addEventListener('touchstart', () => {
    const muteBtn = document.getElementById('muteToggle');
    if (muteBtn.style.display === 'block') {
      muteBtn.classList.remove('hide-controls');
      startAutoHide();
    }
  });

  function initState() {
    const name = document.getElementById('playerName').value.trim() || 'Unbekannt';
    currentState = {
      playerName: name,
      level: 1,
      folgen: 0,
      prinzip: 0,
      verantwortung: 0,
      riskScore: 0,
      startTime: Date.now(),
      endTime: null,
      finalChoice: null
    };
    updateProfileInfo();
  }
  function updateProfileInfo() {
    if (!currentState) {
      document.getElementById('profileInfo').textContent = '';
      return;
    }
    const total = currentState.folgen + currentState.prinzip + currentState.verantwortung || 1;
    const fP = Math.round(currentState.folgen/total*100);
    const pP = Math.round(currentState.prinzip/total*100);
    const vP = Math.round(currentState.verantwortung/total*100);
    document.getElementById('profileInfo').textContent =
      'Aktuelles Profil (' + currentState.playerName + '): Folgenfokus ' + fP +
      '%, Prinzipienfokus ' + pP + '%, Verantwortungsfokus ' + vP + '%.';
  }
  function addDecision(level, typ, risk) {
    if (!currentState) initState();
    currentState.level = level;
    if (typ === 'folgen') currentState.folgen++;
    if (typ === 'prinzip') currentState.prinzip++;
    if (typ === 'verantwortung') currentState.verantwortung++;
    if (risk === 'niedrig') currentState.riskScore += 1;
    if (risk === 'mittel') currentState.riskScore += 2;
    if (risk === 'hoch') currentState.riskScore += 3;
    updateProfileInfo();
    saveGame();
  }

  function showIntro(title, text, nextId) {
    const intro = document.getElementById('chapterIntro');
    document.getElementById('chapterTitle').textContent = title;
    document.getElementById('chapterText').textContent = text;
    intro.dataset.next = nextId || '';
    intro.classList.add('active');
  }
  function closeIntro() {
    const intro = document.getElementById('chapterIntro');
    const next = intro.dataset.next;
    intro.classList.remove('active');
    if (next) {
      const el = document.getElementById(next);
      if (el && el.classList.contains('transition-in')) {
        setTimeout(() => el.classList.add('show'), 10);
      }
    }
  }
  function transitionTo(currentId, nextId, introTitle, introText) {
    const current = currentId ? document.getElementById(currentId) : null;
    const next = document.getElementById(nextId);
    if (current) {
      current.classList.add('transition-out');
      setTimeout(() => { current.style.display = 'none'; }, 350);
    }
    if (next) {
      next.style.display = 'block';
      next.classList.add('transition-in');
    }
    if (introTitle && introText) {
      showIntro(introTitle, introText, nextId);
    } else if (next) {
      setTimeout(() => next.classList.add('show'), 20);
    }
  }

  function newGame() {
    document.querySelectorAll('.choice-box').forEach(el => {
      el.style.display = 'none';
      el.classList.remove('transition-in','transition-out','show');
    });
    document.querySelectorAll('.result').forEach(el => el.style.display = 'none');
    initState();
    const first = document.getElementById('step1');
    first.style.display = 'block';
    first.classList.add('transition-in');
    setTimeout(() => first.classList.add('show'), 20);
    showIntro('Kapitel 1 ‚Äì Start der Alarmrotte',
              'Du h√∂rst die Meldung √ºber das entf√ºhrte Flugzeug und wei√üt, dass du gleich starten wirst.',
              'step1');
  }

  function choose(level, option, typ, risk) {
    addDecision(level, typ, risk);
    const nextLevel = level + 1;
    const currentId = 'step' + level;
    if (nextLevel <= 15) {
      const nextId = 'step' + nextLevel;
      let title = 'Kapitel ' + nextLevel;
      let text = 'Die Situation spitzt sich weiter zu.';
      if (nextLevel === 5) {
        title = 'Kapitel 5 ‚Äì Der Warnschuss';
        text = 'Du hast die M√∂glichkeit, zu warnen, ohne direkt zu t√∂ten.';
      }
      if (nextLevel === 9) {
        title = 'Kapitel 9 ‚Äì Die Zeit l√§uft ab';
        text = 'Sekunden entscheiden jetzt √ºber Leben und Tod.';
      }
      if (nextLevel === 15) {
        title = 'Kapitel 15 ‚Äì Die letzte Entscheidung';
        text = 'Alle √úberlegungen laufen auf einen Moment zu.';
      }
      transitionTo(currentId, nextId, title, text);
    }
  }

  function finishGame(finalChoice) {
    if (!currentState) initState();
    addDecision(15,'verantwortung','hoch');
    currentState.finalChoice = finalChoice;
    currentState.endTime = Date.now();
    saveRun();
    saveGame(true);
    document.querySelectorAll('.choice-box').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.result').forEach(el => el.style.display = 'none');
    if (finalChoice === 'abschuss') {
      document.getElementById('ending_ab').style.display = 'block';
      renderProfile('profile_ab');
    } else {
      document.getElementById('ending_kein').style.display = 'block';
      renderProfile('profile_kein');
    }
  }

  function saveGame(finalFlag) {
    if (!currentState) return;
    localStorage.setItem(SAVE_KEY, JSON.stringify(currentState));
  }
  function loadGame() {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) { alert('Kein Speicherstand vorhanden.'); return; }
    try {
      currentState = JSON.parse(raw);
      updateProfileInfo();
      alert('Profil geladen. Starte ein neues Spiel, um mit diesem Profil weiterzuspielen.');
    } catch(e) {
      alert('Speicherstand konnte nicht gelesen werden.');
    }
  }
  function exportSave() {
    if (!currentState) { alert('Kein aktives Profil ‚Äì starte zuerst ein Spiel.'); return; }
    const blob = new Blob([JSON.stringify(currentState,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'terror_choose_profile_' + (currentState.playerName||'profil') + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  function importSave() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          currentState = JSON.parse(ev.target.result);
          updateProfileInfo();
          saveGame();
          alert('Profil importiert. Starte ein neues Spiel, um mit diesem Profil zu spielen.');
        } catch(err) {
          alert('Datei konnte nicht gelesen werden.');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  }

  function saveRun() {
    try {
      const raw = localStorage.getItem(RUNS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      const total = currentState.folgen + currentState.prinzip + currentState.verantwortung || 1;
      const fP = Math.round(currentState.folgen/total*100);
      const pP = Math.round(currentState.prinzip/total*100);
      const vP = Math.round(currentState.verantwortung/total*100);
      const durationSec = currentState.endTime ? Math.round((currentState.endTime - currentState.startTime)/1000) : null;
      arr.push({
        playerName: currentState.playerName,
        finalChoice: currentState.finalChoice,
        folgenP: fP,
        prinzipP: pP,
        verantwortungP: vP,
        riskScore: currentState.riskScore,
        durationSec: durationSec
      });
      localStorage.setItem(RUNS_KEY, JSON.stringify(arr));
    } catch(e) {
      console.error(e);
    }
  }
  function toggleTeacher() {
    const pw = prompt("Passwort f√ºr Lehrer*innen-Ansicht (Vorschlag: 'terror'):");
    if (pw !== 'terror') {
      alert('Falsches Passwort.');
      return;
    }
    const panel = document.getElementById('teacherPanel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    if (panel.style.display === 'block') renderTeacher();
  }
  function renderTeacher() {
    const raw = localStorage.getItem(RUNS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    const tbody = document.querySelector('#teacherTable tbody');
    tbody.innerHTML = '';
    let sumF=0,sumP=0,sumV=0,sumR=0;
    arr.forEach(run => {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>' + (run.playerName||'') + '</td>' +
                     '<td>' + (run.finalChoice==='abschuss'?'Abschuss':'kein Abschuss') + '</td>' +
                     '<td>' + (run.folgenP||0) + '%</td>' +
                     '<td>' + (run.prinzipP||0) + '%</td>' +
                     '<td>' + (run.verantwortungP||0) + '%</td>' +
                     '<td>' + (run.riskScore||0) + '</td>' +
                     '<td>' + (run.durationSec!=null?run.durationSec:'') + '</td>';
      tbody.appendChild(tr);
      sumF += run.folgenP||0;
      sumP += run.prinzipP||0;
      sumV += run.verantwortungP||0;
      sumR += run.riskScore||0;
    });
    const summary = document.getElementById('teacherSummary');
    if (arr.length === 0) {
      summary.innerHTML = '<p>Noch keine Daten vorhanden.</p>';
    } else {
      const avgF = Math.round(sumF/arr.length);
      const avgP = Math.round(sumP/arr.length);
      const avgV = Math.round(sumV/arr.length);
      const avgR = Math.round(sumR/arr.length);
      summary.innerHTML = '<p>Datens√§tze: ' + arr.length + '</p>' +
                          '<p>Durchschnittlicher Folgenfokus: ' + avgF +
                          '% ‚Äì Prinzipienfokus: ' + avgP +
                          '% ‚Äì Verantwortungsfokus: ' + avgV + '%</p>' +
                          '<p>Durchschnittlicher Risikoscore: ' + avgR + '</p>';
    }
  }

  function renderProfile(targetId) {
    if (!currentState) return;
    const total = currentState.folgen + currentState.prinzip + currentState.verantwortung || 1;
    const fP = Math.round(currentState.folgen/total*100);
    const pP = Math.round(currentState.prinzip/total*100);
    const vP = Math.round(currentState.verantwortung/total*100);
    const risk = currentState.riskScore;
    const durationSec = currentState.endTime ? Math.round((currentState.endTime - currentState.startTime)/1000) : '?';
    const text = '<p><b>Dein Entscheidungsprofil (' + currentState.playerName + '):</b><br>' +
                 'Folgenfokus: ' + fP + '% ‚Äì du hast oft auf die Zahl der m√∂glichen Opfer geschaut.<br>' +
                 'Prinzipienfokus: ' + pP + '% ‚Äì dir war wichtig, dass gewisse Regeln nicht gebrochen werden.<br>' +
                 'Verantwortungsfokus: ' + vP + '% ‚Äì du hast betont, dass jemand die Entscheidung tragen muss.<br>' +
                 'Risikoscore: ' + risk + ' (je h√∂her, desto mehr riskante Optionen).<br>' +
                 'Spieldauer: ' + durationSec + ' Sekunden.</p>';
    const target = document.getElementById(targetId);
    if (target) target.innerHTML = text;
  }

  window.addEventListener('load', () => {
    const raw = localStorage.getItem(SAVE_KEY);
    if (raw) {
      try {
        currentState = JSON.parse(raw);
        updateProfileInfo();
      } catch(e){}
    }
  });
</script>

</body>
</html>
